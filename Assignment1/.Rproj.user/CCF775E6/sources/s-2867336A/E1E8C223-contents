library(tidyverse)
library(fastICA)
library(MineICA)
source("fastICA_modified.R")
source("fICA_functions.R")
#library(pheatmap)
#library(preprocessCore)

#load data
#DATA <- read_csv("/data/projects/data/GTEx/gtex_data_full.csv")
DATA <- read_csv("/data/projects/data/GTEx/gtex_data_subset.csv")
SAMPLE_ATTR <- read_tsv("/data/projects/data/GTEx/GTEx_Analysis_v8_Annotations_SampleAttributesDS.txt")

#variables
TISSUES <- c("Brain - Frontal Cortex (BA9)", "Kidney - Cortex", "Muscle - Skeletal")
#TISSUES <- unique(SAMPLE_ATTR$SMTSD)
PCA <- 0.95
ITER <- 10


#create first col
DATA %>% dplyr::select(Name) -> tissue_modules

library(doParallel)
cl <- makeCluster(20)
registerDoParallel(cl)
#time
time <- list()
ptm <- proc.time()
x <- get_module_df(TISSUES[1], DATA, SAMPLE_ATTR)
time[[TISSUES[1]]] <- proc.time() - ptm
ptm <- proc.time()
x <- get_module_df(TISSUES[2], DATA, SAMPLE_ATTR)
time[[TISSUES[2]]] <- proc.time() - ptm
ptm <- proc.time()
x <- get_module_df(TISSUES[3], DATA, SAMPLE_ATTR)
time[[TISSUES[3]]] <- proc.time() - ptm
save(time, file="time_10.Rdata")
load("time.Rdata")
time_10
time
#add remaining modules for each tissue
# for (tissue in TISSUES){
#   tissue_modules <- cbind(tissue_modules, get_module_df(tissue, DATA, SAMPLE_ATTR))
# }


#save file
#write.table(tissue_modules, file = "results/modules_updated_time.txt", row.names = F, quote = F, sep = "\t")

#old_modules <- read_tsv("results/modules.txt")
#dim(old_modules)
#dim(tissue_modules)

